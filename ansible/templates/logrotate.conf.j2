# ByteFreezer Proxy Log Rotation Configuration
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

{{ bytefreezer_proxy_log_dir }}/*.log {
    # Rotation schedule
    {{ bytefreezer_proxy_logrotate.frequency | default('daily') }}
    
    # Keep rotated logs
    rotate {{ bytefreezer_proxy_logrotate.rotate_count | default(30) }}
    
    # Compress old logs
    compress
    delaycompress
    
    # Don't rotate empty logs
    notifempty
    
    # Create new log file with specific permissions
    create 0644 {{ bytefreezer_proxy_user }} {{ bytefreezer_proxy_group }}
    
    # Handle missing log files gracefully
    missingok
    
    # Use date extension instead of numbers
    dateext
    dateformat -%Y-%m-%d
    
    # Copy and truncate original file (for services that don't handle SIGHUP)
    copytruncate
    
    # Size-based rotation (optional)
    {% if bytefreezer_proxy_logrotate.max_size is defined %}
    size {{ bytefreezer_proxy_logrotate.max_size }}
    {% endif %}
    
    # Post-rotation script
    postrotate
        # Send SIGHUP to bytefreezer-proxy to reopen log files
        /bin/systemctl reload {{ bytefreezer_proxy_service_name }} > /dev/null 2>&1 || true
    endscript
}

# Spooling directory log rotation (if spooling is enabled)
{% if bytefreezer_proxy_config.spooling.enabled | default(false) %}
{{ bytefreezer_proxy_config.spooling.directory | default('/tmp/bytefreezer-proxy') }}/*.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    create 0644 {{ bytefreezer_proxy_user }} {{ bytefreezer_proxy_group }}
    missingok
    copytruncate
    maxage 30
}
{% endif %}